# 杰理AC792的AI终端项目模块功能描述

# 项目概述

本项目基于杰理AC792平台SDK开发。杰理SDK部分代码开源，开源部分的代码还在快速迭代升级中。小版本的升级中也会有比较多的源码优化变动；开源SDK中的样例项目包含的功能涵盖多种场景应用，业务功能相对比较复杂；部分Demo代码与业务代码交织在demo目录和基础模块目录中。部分模块的功能包含基础模块的头文件，但是SDK中存在同名的头文件, 如debug.h等，导致项目工程（或makefile）的头文件包含顺序会影响编译结果。基于这些情况，本项目没有严格遵循官方SDK的开发策略，如下：

1.  创建新的项目文件，尽量最小化引入SDK模块依赖；工程文件的模块按名称顺序导入；
    
2.  /smart\_robot/目录下的模块称为应用层；其他官方定义的目录称为(官方)基础模块；
    
3.  对有重名的官方头文件的引入，在引入时通过增加目录名指定头文件，提高项目编译的确定性；
    
4.  严格避免使用诸如"demo"的目录或路径;
    
5.  应用模块不直接使用官方的代码；通过对官方代码的修订和简化，并把代码放在/smart\_robot目录下；
    
6.  应用层的所有模块的头文件统一放在/smart\_robot/include/目录下;
    
7.  结构体、枚举值定义统一通过typedef修饰，以"\_t"结束命名，以"\_ptr"结束命名对应的指针类型。
    

# 项目模块说明

## 自定义事件

杰理SDK支持通过事件分发机制，可以在各个模块之间解耦通信。由于官方SDK没有为应用层预留事件值空间，事件定义文件放置在基础模块目录。为了减少对官方基础模块的侵入，项目定义了一套基于 `sys_event_notify` 的事件分发机制，用于各模块间的解耦通信。

*   **头文件**: /smar\_robot/include/app\_event.h
    
*   **模块目录**： /smar\_robot/event
    
*   **模块接口**:
    
    *   定义了统一的事件结构体 `struct app_event`。
        
    *   支持不同应用层模块来源 (`enum app_event_from`) 的事件通知。
        
    *   提供 `app_event_notify` 接口，允许模块发送系统级事件，由主循环或特定任务进行处理。
        
*   **说明**
    
    *   根据测试，SDK的时间分发机制的处理是同步的，所以时间处理函数中不应该有阻塞或长耗时操作。
        

## 蓝牙配网

通过低功耗蓝牙 (BLE) 实现设备的 Wi-Fi 网络配置功能。在配网的过程中，设备需要通过蓝牙上传厂商编码(UID)、产品类型编码和设备的Flash Unique ID。对于 NAND Flash 芯片本身，它通常会有一个 **Unique ID (UID) 或 Serial Number**。这个 UID 或序列号在出厂时就固化在每个独立的 NAND 芯片内部，是唯一的。 这种 ID 主要用于底层硬件的安全配对或芯片管理。项目中使用这个flash UID来作为设备的唯一标识。请注意不同的设备的flash UID的长度可能不一样。

移动端通过BLE向设备写入可用的WiFi热点的SSID和密码。

*   **头文件**: /smar\_robot/include/app\_ble.h
    
*   **模块目录**：/smart\_robot/bt\_ble，/smart\_robot/wifi
    
*   **模块接口**:
    
    *   蓝牙配网初始化:  初始化蓝牙配网模块，进入配网模式。
        

## OTA升级

本项目支持通过 HTTP 协议进行固件的远程空中升级。项目摒弃SDK中的版本号管理，采用语义化版本，只需更新FIRMWARE\_VERSION宏定义值，即可在设备开机的时候触发OTA升级。

更新版本号时， 不需要更新BR22\_TWS\_VERSION。但是请遵循SDK中的说明，执行批命令制作升级文件。

*   **头文件**: /smar\_robot/include/app\_ota.h
    

*   **模块目录**：/smart\_robot/ota
    
*   **模块接口**:
    
    *   开机注册:  设备开机后需要调用注册函数，向平台注册设备，获取通讯接入参数。
        

## 会话协议

设备与服务器的协议包括通话控制、MCP、语音媒体数据传输3个协议。

*   **头文件**: /smar\_robot/include/app\_protocol.h
    

*   **模块目录**：/smart\_robot/protocol
    

### 2.4.1 信令传输

项目采用MQTT协议传输服务器与设备之间的控制指令(包括SIP和MCP)。官方SDK集成IBM开源的MQTT协议栈。该协议栈不支持接收、发送并行，也不支持在接收处理中嵌套调用发送函数，如果没有遵循这个约束，协议栈会引起非法指针访问。

### 2.4.2 通话控制协议

项目采用SIP协议进行会话控制。项目的SIP协议报文定义请参考“拓云AI IOT平台设备接入手册2.0”。目前项目的SIP信令仅支持mqtt传输，不支持websocket。项目SIP编解码采用开源SIP协议库OSIP。

### 2.4.3 MCP协议

项目支持的MCP协议版本是"2024-11-05"。

### 2.4.4 语音媒体传输

项目采用UDP传输语音数据。目前上行、下行语音都仅支持无封装的OPUS编码。由于网络传输中，可能是由于设备的WiFi链路层有大量的重传，语音报文的序号检测和去重必不可少。

在会话初始化完成后，设备需要持续向服务器发送空语音报文, 用于打通UDP通道。目前的策略是收到下行语音报文时，停止发送上行空语音包。

## 语音处理

负责音频的采集、编码、传输以及播放，支持全双工语音交互。

*   **核心实现**: app\_audio.c
    
*   **头文件**: /smar\_robot/include/app\_protocol.h
    

*   **模块目录**：/smart\_robot/protocol
    

*   **功能**:
    
    *   **音频采集**: 使用 `tuoyun_voice_recorder` 模块采集麦克风数据。
        
    *   **音频播放**: 使用 `tuoyun_flow_player` 模块播放网络下发的音频流。
        
    *   **编解码**: 支持 Opus 编码格式 (`g_audio_enc_media_param`)，采样率 16kHz。
        
    *   **流式传输**: 实时发送录音数据包，并接收播放数据包。
        
    *   **状态管理**: 维护麦克风和扬声器的工作状态（Start/Stop/Pending）。
        

## 用户UI

开发中...

## 日志服务

官方SDK的日志需要通过串口输出。如果没有开发板，那么获取日志打印的的手段受限。鉴于这种情况，项目中引入Telnet Server日志输出模块。当终端连上WiFi并成功获取IP后，会打开TCP 6000端口，在6000端口输出日志打印。

项目的Telnet Server模块通过 `app_config.h`的TELNET\_LOG\_OUTPUT宏定义开关。